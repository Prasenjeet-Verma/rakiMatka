<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <link rel="stylesheet" href="/css/adminDashbord.css">

</head>

<body class="flex min-h-screen">
  <aside id="sidebar"
    class="sidebar border-r border-gray-200 fixed inset-y-0 left-0 z-50 lg:relative lg:translate-x-0 transform -translate-x-full lg:block ">
    <div class="p-4">
      <div class="relative mb-4">
        <input type="text" placeholder="Search"
          class="w-full bg-white border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-blue-500" />
        <button class="absolute right-0 top-0 bottom-0 px-3 bg-neutral-800 text-white rounded-r">
          <i class="fas fa-search"></i>
        </button>
      </div>
    </div>

    <!-- ============================= Nav is here ============================ -->

    <%- include('../partials/adminNav') %>
  </aside>

  <main class="flex-1 flex flex-col min-w-0 overflow-hidden">

    <!-- ============================= Header is here ============================ -->
    <header style="z-index: 50000; position: fixed; width: 100%;"
      class="bg-white h-14 flex items-center justify-between px-4 border-b border-gray-200">
      <button id="menuBtn" class="text-gray-600 focus:outline-none">
        <i class="fas fa-bars text-xl"></i>
      </button>
      <button class="text-gray-600">
        <i class="fas fa-power-off text-xl"></i>
      </button>
    </header>



    <header class="bg-white h-14 flex items-center justify-between px-4 border-b border-gray-200">
    </header> <!-- header overflow done -->

    <!-- =========================================== Body Start here ========================================== -->
    <main class="bg-gray-100 p-4">

      <!-- CARD -->
      <div class="bg-white rounded-lg shadow p-4">

        <!-- HEADER -->
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
          <h2 class="text-lg font-semibold">Users</h2>
          <!-- <button class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600">
      Create User
    </button> -->

          <button id="openModal" class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600">
            Create User
          </button>

        </div>

        <!-- CONTROLS -->
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">

          <div class="flex items-center gap-2 text-sm">
            <span>Show</span>
            <select class="border rounded px-2 py-1" onchange="changeLimit(this.value)">
              <option value="10" <%=limit==10 ? "selected" : "" %>>10</option>
              <option value="50" <%=limit==50 ? "selected" : "" %>>50</option>
              <option value="100" <%=limit==100 ? "selected" : "" %>>100</option>
              <option value="all" <%=limit==0 ? "selected" : "" %>>All</option>
            </select>
          </div>

          <div class="flex items-center gap-2 text-sm">
            <label>Search:</label>
            <input type="text" id="userSearch" class="border rounded px-2 py-1" placeholder="Search username"
              value="<%= search || '' %>">
          </div>

        </div>

        <!-- TABLE WRAPPER -->
        <div class="overflow-x-auto">
          <table class="min-w-full border text-sm">

            <!-- HEAD -->
            <thead class="bg-gray-100 text-left">
              <tr>
                <th class="border px-3 py-2">ID</th>
                <th class="border px-3 py-2">Mobile</th>
                <th class="border px-3 py-2">Name</th>
                <th class="border px-3 py-2">MPin</th>
                <th class="border px-3 py-2">Wallet</th>
                <th class="border px-3 py-2">Registered on</th>
                <th class="border px-3 py-2">Active</th>
                <th class="border px-3 py-2">Action</th>
              </tr>
            </thead>

            <!-- BODY -->
            <tbody id="userTable">
              <% users.forEach((user, index)=> { %>
                <tr class="hover:bg-gray-50">
                  <td class="border px-3 py-2">
                    <%= index + 1 %>
                  </td>

                  <td class="border px-3 py-2">
                    <%= user.phoneNo %>
                  </td>

                  <td class="border px-3 py-2 username">
                    <%= user.username %>
                  </td>

                  <td class="border px-3 py-2">****</td>

                  <td class="border px-3 py-2 flex items-center gap-2">
                    ₹ <%= user.wallet %>
                      <button class="openWalletModal bg-gray-600 text-white px-2 py-1 rounded text-xs"
                        data-userid="<%= user._id %>" data-balance="<%= user.wallet %>">✎</button>
                  </td>

                  <td class="border px-3 py-2">
                    <%= new Date(user.createdAt).toLocaleString() %>
                  </td>

                  <td class="border px-3 py-2">
                    <% if(user.userStatus==="active" ) { %>
                      <span class="bg-green-600 text-white px-3 py-1 rounded text-xs">
                        Active
                      </span>
                      <% } else { %>
                        <span class="bg-red-600 text-white px-3 py-1 rounded text-xs">
                          Blocked
                        </span>
                        <% } %>
                  </td>

                  <td class="border px-3 py-2 flex gap-2">
                    <button onclick="toggleUser('<%= user._id %>')"
                      class="bg-red-600 text-white px-3 py-1 rounded text-xs">
                      <%= user.userStatus==="active" ? "Block" : "Unblock" %>
                    </button>

                    <a href="/admin/singleuser-details/<%= user._id %>">
                      <button class="bg-yellow-500 text-white px-3 py-1 rounded text-xs">
                        View
                      </button>
                    </a>
                  </td>
                </tr>
                <% }) %>
            </tbody>

          </table>
        </div>

        <!-- FOOTER -->
        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3 mt-4 text-sm">

          <!-- Showing text -->
          <div>
            Showing
            <%= (currentPage - 1) * (limit || totalUsers) + 1 %>
              to
              <%= Math.min(currentPage * (limit || totalUsers), totalUsers) %>
                of <%= totalUsers %> entries
          </div>

          <!-- Pagination buttons -->
          <div class="flex gap-2 items-center">

            <% if (currentPage> 1) { %>
              <a href="/admin/allUsers?page=<%= currentPage - 1 %>&limit=<%= limit || 'all' %>"
                class="border px-2 py-1 rounded">Previous</a>
              <% } %>

                <% let start=Math.max(1, currentPage - 2); let end=Math.min(totalPages, currentPage + 2); %>

                  <% if (start> 1) { %>
                    <a href="/admin/allUsers?page=1&limit=<%= limit || 'all' %>" class="border px-3 py-1 rounded">1</a>
                    <% if (start> 2) { %> <span>...</span>
                      <% } %>
                        <% } %>

                          <% for (let i=start; i <=end; i++) { %>
                            <a href="/admin/allUsers?page=<%= i %>&limit=<%= limit || 'all' %>"
                              class="<%= i === currentPage ? 'bg-blue-600 text-white' : 'border' %> px-3 py-1 rounded">
                              <%= i %>
                            </a>
                            <% } %>

                              <% if (end < totalPages) { %>
                                <% if (end < totalPages - 1) { %> <span>...</span>
                                  <% } %>
                                    <a href="/admin/allUsers?page=<%= totalPages %>&limit=<%= limit || 'all' %>"
                                      class="border px-3 py-1 rounded">
                                      <%= totalPages %>
                                    </a>
                                    <% } %>

                                      <% if (currentPage < totalPages) { %>
                                        <a href="/admin/allUsers?page=<%= currentPage + 1 %>&limit=<%= limit || 'all' %>"
                                          class="border px-2 py-1 rounded">Next</a>
                                        <% } %>

          </div>
        </div>


      </div>

    </main>


    <!-- =========================================== Create User Modal here ========================================== -->
    <input type="hidden" id="openModalOnLoad" value="<%= errors && errors.length > 0 ? 'true' : 'false' %>">

    <!-- MODAL BACKDROP -->
    <div id="userModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">

      <!-- MODAL BOX -->
      <div class="bg-white rounded-lg w-full max-w-md p-5 relative">

        <!-- MODAL HEADER -->
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-semibold">Create User</h3>
          <button id="closeModal" class="text-gray-500 hover:text-black text-xl">
            &times;
          </button>
        </div>

        <!-- FORM -->
        <% if (errors && errors.length> 0) { %>
          <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-2 rounded mb-3">
            <% errors.forEach(err=> { %>
              <p>• <%= err %>
              </p>
              <% }) %>
          </div>
          <% } %>

            <form action="/admin/createuser" method="POST" class="space-y-3">

              <div>
                <label class="text-sm font-medium">Name</label>
                <input type="text" name="username" value="<%= oldInput?.username || '' %>"
                  class="w-full border rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
              </div>

              <div>
                <label class="text-sm font-medium">Mobile</label>
                <input type="text" name="phoneNo" value="<%= oldInput?.phoneNo || '' %>"
                  class="w-full border rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
              </div>

              <div>
                <label class="text-sm font-medium">Password</label>
                <input type="password" name="password"
                  class="w-full border rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
              </div>

              <div>
                <label class="text-sm font-medium">Wallet Amount</label>
                <input type="number" name="wallet" value="<%= oldInput?.wallet || '' %>"
                  class="w-full border rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
              </div>

              <!-- ACTIONS -->
              <div class="flex justify-end gap-2 pt-3">
                <button type="button" id="cancelModal" class="border px-4 py-2 rounded hover:bg-gray-100">
                  Cancel
                </button>
                <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                  Create
                </button>
              </div>

            </form>
      </div>
    </div>


    <!-- =========================================== Debit / Credit Modal here ========================================== -->

    <!-- MODAL BACKDROP -->
    <div id="walletModal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50">

      <!-- MODAL -->
      <div class="bg-white w-full max-w-lg rounded-lg shadow-lg">

        <!-- HEADER -->
        <div class="flex justify-between items-center px-5 py-4 border-b">
          <h2 class="text-xl font-semibold">Add / Withdraw Points</h2>
          <button id="closeWalletModal" class="text-2xl text-gray-500 hover:text-black">
            &times;
          </button>
        </div>

        <!-- BODY -->
        <div class="p-5 space-y-4">

          <div>
            <label class="block text-sm font-medium mb-1">Amount</label>
            <input type="number" placeholder="Enter Points Here"
              class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">Debit / Credit</label>
            <select class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="credit">Credit</option>
              <option value="debit">Debit</option>
            </select>
          </div>

        </div>

        <!-- FOOTER -->
        <div class="flex justify-end gap-3 px-5 py-4 border-t">
          <button id="submitWallet" class="bg-green-600 text-white px-5 py-2 rounded hover:bg-green-700">
            Submit
          </button>
          <button id="cancelWalletModal" class="bg-red-600 text-white px-5 py-2 rounded hover:bg-red-700">
            Close
          </button>
        </div>

      </div>
    </div>

    </div>
  </main>

  <script src="/js/adminAdUser.js"></script>
  <script src="/js/dabitCradit.js"></script>
  <script src="/js/sidebar.js"></script>
  <script src="/js/calander.js"></script>
  <script>
    function changeLimit(val) {
      window.location.href = `/admin/allUsers?page=1&limit=${val}`;
    }
  </script>
  <!-- =========================================== Block Confirm Modal here ========================================== -->

  <div id="blockConfirmModal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50">

    <div class="bg-white rounded-lg w-full max-w-sm p-5">

      <h2 class="text-lg font-semibold mb-3">Confirm Action</h2>
      <p class="text-gray-600 mb-4">Are you sure you want to change this user's status?</p>

      <div class="flex justify-end gap-3">
        <button id="cancelBlock" class="px-4 py-2 border rounded hover:bg-gray-100">
          Cancel
        </button>

        <button id="confirmBlock" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
          Yes, Continue
        </button>
      </div>

    </div>
  </div>

</body>

</html>